#!/bin/bash

# Configuration file to store connections
CONFIG_FILE="$HOME/.ssh_connections.conf"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to create the configuration file if it doesn't exist
init_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        touch "$CONFIG_FILE"
        echo -e "${GREEN}Configuration file created: $CONFIG_FILE${NC}"
    fi
}

# Function to show help
show_help() {
    echo -e "${BLUE}=== SSH Connection Manager ===${NC}"
    echo ""
    echo "Usage: conn <command> [options]"
    echo ""
    echo "Available commands:"
    echo "  to <alias>         - Connect to the server with the specified alias"
    echo "  list               - Show the list of all configured servers"
    echo "  add                - Add a new connection"
    echo "  remove <alias>     - Remove an existing connection"
    echo "  reset <alias>      - Remove SSH host key for the specified alias"
    echo "  help               - Show this help message"
    echo ""
}

# Function to list all connections
list_connections() {
    init_config
    
    if [ ! -s "$CONFIG_FILE" ]; then
        echo -e "${YELLOW}No connections configured.${NC}"
        echo -e "${YELLOW}Use 'conn add' to add a new connection.${NC}"
        return
    fi
    
    echo -e "${BLUE}=== SSH Servers List ===${NC}"
    echo ""
    
    while IFS='|' read -r alias user host port; do
        if [ -n "$alias" ]; then
            echo -e "${GREEN}$alias${NC} - ${user}@${host}:${port}"
        fi
    done < "$CONFIG_FILE"
    echo ""
}

# Function to add a new connection
add_connection() {
    init_config
    
    echo -e "${BLUE}=== Add New SSH Connection ===${NC}"
    echo ""
    
    # Request alias
    read -p "Type alias: " alias
    if [ -z "$alias" ]; then
        echo -e "${RED}Error: alias cannot be empty!${NC}"
        return 1
    fi
    
    # Check if alias already exists
    if grep -q "^$alias|" "$CONFIG_FILE" 2>/dev/null; then
        echo -e "${RED}Error: alias '$alias' already exists!${NC}"
        return 1
    fi
    
    # Request user (default: root)
    read -p "Type user (default: root): " user
    user=${user:-root}
    
    # Request host
    read -p "Type host: " host
    if [ -z "$host" ]; then
        echo -e "${RED}Error: host cannot be empty!${NC}"
        return 1
    fi
    
    # Request port (default: 22)
    read -p "Type port (default: 22): " port
    port=${port:-22}
    
    # Save the connection
    echo "$alias|$user|$host|$port" >> "$CONFIG_FILE"
    
    echo ""
    echo -e "${GREEN}✓ Connection '$alias' added successfully!${NC}"
    echo -e "  ${user}@${host}:${port}"
    echo ""
}

# Function to remove a connection
remove_connection() {
    init_config
    
    if [ -z "$1" ]; then
        echo -e "${RED}Error: please specify an alias!${NC}"
        echo "Usage: conn remove <alias>"
        return 1
    fi
    
    alias="$1"
    
    # Check if alias exists
    if ! grep -q "^$alias|" "$CONFIG_FILE" 2>/dev/null; then
        echo -e "${RED}Error: alias '$alias' does not exist!${NC}"
        return 1
    fi
    
    # Show connection details
    connection=$(grep "^$alias|" "$CONFIG_FILE")
    IFS='|' read -r al user host port <<< "$connection"
    
    echo -e "${YELLOW}You are about to remove:${NC}"
    echo -e "  Alias: ${GREEN}$al${NC}"
    echo -e "  Connection: ${user}@${host}:${port}"
    echo ""
    
    # Ask for confirmation
    read -p "Are you sure you want to proceed? (y/N): " confirm
    
    if [[ "$confirm" =~ ^[yY]$ ]]; then
        # Remove the line from file
        sed -i.bak "/^$alias|/d" "$CONFIG_FILE"
        rm -f "${CONFIG_FILE}.bak"
        echo -e "${GREEN}✓ Connection '$alias' removed successfully!${NC}"
    else
        echo -e "${YELLOW}Operation cancelled.${NC}"
    fi
}

# Function to connect to a server
connect_to() {
    init_config
    
    if [ -z "$1" ]; then
        echo -e "${RED}Error: please specify an alias!${NC}"
        echo "Usage: conn to <alias>"
        return 1
    fi
    
    alias="$1"
    
    # Search for the connection
    connection=$(grep "^$alias|" "$CONFIG_FILE" 2>/dev/null)
    
    if [ -z "$connection" ]; then
        echo -e "${RED}Error: alias '$alias' does not exist!${NC}"
        echo -e "${YELLOW}Use 'conn list' to see available connections.${NC}"
        return 1
    fi
    
    # Extract details
    IFS='|' read -r al user host port <<< "$connection"
    
    echo -e "${GREEN}Connecting to $alias...${NC}"
    echo -e "  ${user}@${host}:${port}"
    echo ""
    
    # Execute SSH connection
    ssh "$user@$host" -p "$port"
}

# Function to reset SSH keys
reset_host() {
    init_config
    
    if [ -z "$1" ]; then
        echo -e "${RED}Error: please specify an alias!${NC}"
        echo "Usage: conn reset <alias>"
        return 1
    fi
    
    alias="$1"
    
    # Search for the connection
    connection=$(grep "^$alias|" "$CONFIG_FILE" 2>/dev/null)
    
    if [ -z "$connection" ]; then
        echo -e "${RED}Error: alias '$alias' does not exist!${NC}"
        return 1
    fi
    
    # Extract host
    IFS='|' read -r al user host port <<< "$connection"
    
    echo -e "${YELLOW}Resetting SSH keys for:${NC}"
    echo -e "  Host: ${host}"
    echo -e "  Port: ${port}"
    echo ""
    
    # Execute ssh-keygen -R
    if [ "$port" == "22" ]; then
        ssh-keygen -R "$host"
    else
        ssh-keygen -R "[$host]:$port"
    fi
    
    echo ""
    echo -e "${GREEN}✓ SSH keys reset for '$alias'!${NC}"
}

# Main script
main() {
    if [ $# -eq 0 ]; then
        show_help
        return
    fi
    
    command="$1"
    shift
    
    case "$command" in
        to)
            connect_to "$@"
            ;;
        list)
            list_connections
            ;;
        add)
            add_connection
            ;;
        remove)
            remove_connection "$@"
            ;;
        reset)
            reset_host "$@"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            echo -e "${RED}Error: unknown command '$command'${NC}"
            echo ""
            show_help
            return 1
            ;;
    esac
}

# Execute main
main "$@"
